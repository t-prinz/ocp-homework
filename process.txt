#
# The various scripts, Ansible playbooks, and other supporting files are stored in git:
# https://github.com/t-prinz/ocp-homework
#

#
# Metrics, logging, and etcd all create directories in /exports on the server, regardless
# of what is specified in the configuration file
#
# Registry abides by what is specified in the configuration file
#
# The OpenShift installer will create an exports file:  /etc/exports.d/openshift-ansible.exports
#

#
# On bastion as root user
#
# This installs the OCP Ansible installer and, if needed, Ansible
#

yum install -y atomic-openshift-utils

#
# Install the screen utility if desired
#

yum install -y screen

#
# Save the original Ansible hosts file for reference
#

cp /etc/ansible/hosts /etc/ansible/hosts.orig

#
# On bastion as root user
#
# Run the setup.sh script to install the root ssh public key
# This will allow Ansible to access all of the nodes
#

./ssh-setup.sh

#
# Configure RHSM if needed
#

subscription-manager register
subscription-manager list --available --matches '*OpenShift*'
subscription-manager attach --pool=8a85f98c608ccb070160913e1c1a1cab
subscription-manager repos --disable="*"
yum-config-manager --disable \*
subscription-manager repos \
    --enable="rhel-7-server-rpms" \
    --enable="rhel-7-server-extras-rpms" \
    --enable="rhel-7-server-ose-3.7-rpms" \
    --enable="rhel-7-fast-datapath-rpms"

#
# Run the Ansible playbook that installs the OpenShift software on all of the nodes
#

ansible-playbook software-setup.yml

#
# Run the Ansible playbook that sets up the bastion host as a NFS server
# This also creates an export for a directory to hold persistent volumes
#

ansible-playbook nfs-setup.yml

#
# Run the Ansible playbook that sets up htpasswd authentication for 3 users
# This file will get copied to the OpenShift nodes during installation
#

ansible-playbook authentication-setup.yml

#openshift_clock_enabled=true

# Run the installer

ansible-playbook /usr/share/ansible/openshift-ansible/playbooks/byo/config.yml
